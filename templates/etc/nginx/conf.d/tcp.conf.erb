<% if ENV['PROTOCOL'] == 'tcp' %>
stream {
  error_log /proc/self/fd/1;

  <% (ENV['UPSTREAM_SERVER_PORTS'] || '').split(',').each do |port| %>
    <% unless [nil, ''].include? ENV["UPSTREAM_SERVERS_#{port}"] %>
    upstream containers_<%= port %> {
      <% ENV["UPSTREAM_SERVERS_#{port}"].split(',').each do |server| %>
      server <%= server %>;
      <% end %>
    }

    server {
      listen <%= port %>;
      proxy_pass containers_<%= port %>;
    }
    <% end %>
  <% end %>
}
<% end %>
